---
title: "pivot & prep databases for analysis in R"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



## Set library and working directory
```{r}
library(tidyverse)
library(dplyr)
library(tidyr)

setwd("C:/Users/baill/OneDrive/r-projects/cormorant-colony-analysis")
```

## import data 
separately for each species
check.names function forces r to not add X to numeric column names
```{r}
data_dcco <- read.csv("C:/Users/baill/OneDrive/r-projects/cormorant-colony-analysis/data/dcco_database_july30th.csv", check.names = FALSE)
```

## long pivot data
This code filters out rows in the data_bcnh dataset where the xcoord or ycoord columns have missing values. It then reshapes the data from a wide format to a long format, creating a row for each tree tag and year combination with the corresponding count. Finally, it replaces any missing values in the count column with zeros.

To get data working in ArcGIS, I had to remove rows with missing x and y coordinates. I also had to pivot the data from wide to long format, so that each row represents a single tree tag and year with the corresponding count. Finally, I replaced any missing values in the count column with zeros. There could be no NAs (the letters) in integer or numeric columns for the data to work in ArcGIS- XY table to point wouldn't read coordinates.
```{r}
data_dcco_pivot <- data_dcco |>
    filter(!is.na(xcoord) & !is.na(ycoord)) |>
    pivot_longer(
        cols = `1992`:`2023`,
        names_to = "year",
        values_to = "count"
    ) |>
    replace_na(list(count = 0))
```
## save csv
Save cleaned data as CSV to post-clean data folder
```{r}
write.csv(data_dcco_pivot,
    file = "C:\\Users\\baill\\OneDrive\\r-projects\\cormorant-colony-analysis\\data\\post-clean\\data_dcco_cleaned_july31.csv",
    row.names = FALSE
)
```
## Save version that includes NA coordinate counts (may be useful in R model)
```{r}
dcco_pivot_includesnacoord <- data_bcnh %>%
    mutate(
        xcoord = replace_na(xcoord, 0),
        ycoord = replace_na(ycoord, 0)
    ) %>%
    pivot_longer(
        cols = `1992`:`2023`,
        names_to = "year",
        values_to = "count"
    ) %>%
    replace_na(list(count = 0))

write.csv(dcco_pivot_includesnacoord,
    file = "C:\\Users\\baill\\OneDrive\\r-projects\\cormorant-colony-analysis\\data\\post-clean\\data_dcco_cleaned_withnacoords_july31.csv",
    row.names = FALSE
)
```

## view dcco data
summarize yearly data for dcco to compare to original database for accuracy
```{r}      
data_dcco_sum <- data_dcco_pivot |>
    group_by(year) |>
    summarize(sum = sum(count, na.rm = TRUE))
```
# Plot year by population
```{r}
ggplot(data_dcco_sum, aes(x = year, y = sum)) +
    geom_col() +
    labs(x = "Year", y = "Population Count") +
    ggtitle("Population Count by Year")
```
# Compare yearly totals from original dcco_data to data_dcco_sum
This isn't working; still need to fix. Manually compared values to ensure approximate accuracy.
```{r}
# Sum total counts for each year in original data_dcco
data_dcco_total <- data_dcco |>
    group_by(year) |>
    summarize(total_count = sum(count, na.rm = TRUE))

# Compare counts per year between original data_dcco and data_dcco_sum
comparison <- data.frame(
    Year = data_dcco_total$year,
    Original_Count = data_dcco_total$total_count,
    Sum_Count = data_dcco_sum$sum
)

comparison
```
# repeat all steps for BCNH
Code for comparison isn't working;still need to fix.

```{r}
data_bcnh <- read.csv("C:/Users/baill/OneDrive/r-projects/cormorant-colony-analysis/data/bcnh_database_july30th.csv", check.names = FALSE)
```

```{r}
# long pivot data for bcnh
data_bcnh_pivot <- data_bcnh %>%
    filter(!is.na(xcoord) & !is.na(ycoord)) %>%
    pivot_longer(
        cols = `1992`:`2023`,
        names_to = "year",
        values_to = "count"
    ) %>%
    replace_na(list(count = 0))
```
## Save version that includes NA coordinate counts (may be useful in R model)
```{r}
bcnh_pivot_includesnacoord <- data_bcnh %>%
    mutate(
        xcoord = replace_na(xcoord, 0),
        ycoord = replace_na(ycoord, 0)
    ) %>%
    pivot_longer(
        cols = `1992`:`2023`,
        names_to = "year",
        values_to = "count"
    ) %>%
    replace_na(list(count = 0))

write.csv(bcnh_pivot_includesnacoord,
    file = "C:\\Users\\baill\\OneDrive\\r-projects\\cormorant-colony-analysis\\data\\post-clean\\data_bcnh_cleaned_withnacoords_july31.csv",
    row.names = FALSE
)
```

```{r}
# save cleaned data as CSV for bcnh
write.csv(data_bcnh_pivot, file = "C:\\Users\\baill\\OneDrive\\r-projects\\cormorant-colony-analysis\\data\\post-clean\\data_bcnh_cleaned_july31.csv")

# summarize yearly data for bcnh
data_bcnh_sum <- data_bcnh_pivot |>
    group_by(year) |>
    summarize(sum = sum(count, na.rm = TRUE))
print(data_bcnh_sum)

# plot year by population for bcnh
ggplot(data_bcnh_sum, aes(x = year, y = sum)) +
    geom_col() +
    labs(x = "Year", y = "Population Count") +
    ggtitle("Population Count by Year for BCNH")
```

# compare yearly totals from original data_bcnh to data_bcnh_sum
This chunk of code isn't functioning; not sure why.
```{r}
data_bcnh_total <- data_bcnh |>
    group_by(year) |>
    summarize(total_count = sum(count, na.rm = TRUE))

comparison_bcnh <- data.frame(
    Year = data_bcnh_total$year,
    Original_Count = data_bcnh_total$total_count,
    Sum_Count = data_bcnh_sum$sum
)

comparison_bcnh
```